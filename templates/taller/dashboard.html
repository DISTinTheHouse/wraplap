{% extends "taller/base.html" %}

{% block title %}The Wrap Lab | Dashboard{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
  <!-- Header & Actions -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-3xl font-bold tracking-tight text-white">Dashboard</h1>
      <p class="mt-2 text-zinc-400">Gestión de órdenes y seguimiento.</p>
    </div>
    <a class="group inline-flex items-center justify-center gap-2 rounded-xl bg-white px-5 py-3 text-sm font-semibold text-zinc-950 transition hover:bg-zinc-200"
      href="{% url 'orden_nueva' %}">
      <svg class="h-5 w-5 text-zinc-600 transition group-hover:text-zinc-950" fill="none" viewBox="0 0 24 24"
        stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
      </svg>
      Nueva Orden
    </a>
  </div>

  <!-- Search -->
  <div class="relative">
    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-4">
      <svg class="h-5 w-5 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <form method="get">
      <input
        class="w-full rounded-2xl border border-zinc-800 bg-zinc-900/50 py-4 pl-12 pr-4 text-white placeholder-zinc-500 shadow-sm backdrop-blur-sm transition focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
        name="q" value="{{ q }}" placeholder="Buscar por folio, cliente, vehículo, matrícula o estatus..."
        autocomplete="off" />
    </form>
  </div>

  <div class="grid gap-6 md:gap-8 lg:grid-cols-3">
    <!-- Main Content: Orders -->
    <div class="flex min-w-0 flex-col gap-6 md:gap-8 lg:col-span-2">

      <!-- Activas -->
      <div class="space-y-4">
        <h2 class="flex items-center gap-2 text-lg font-semibold text-white">
          <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
          Órdenes Activas
        </h2>

        <div class="overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/50 shadow-sm backdrop-blur-sm">
          <div class="overflow-x-auto">
            <table class="w-full whitespace-nowrap text-left text-sm">
              <thead class="bg-zinc-950/50 text-zinc-400">
                <tr>
                  <th class="px-6 py-4 font-medium">Folio</th>
                  <th class="px-6 py-4 font-medium">Vehículo</th>
                  <th class="px-6 py-4 font-medium">Matrícula</th>
                  <th class="px-6 py-4 font-medium">Servicio</th>
                  <th class="px-6 py-4 font-medium">Estatus</th>
                  <th class="px-6 py-4 font-medium">Actualizado</th>
                  <th class="px-6 py-4 text-right font-medium">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-zinc-800">
                {% for o in activas %}
                <tr class="group transition hover:bg-zinc-800/50">
                  <td class="px-6 py-4">
                    <a class="font-semibold text-white hover:text-sky-400 hover:underline"
                      href="{% url 'orden_detalle' pk=o.pk %}">
                      {{ o.folio }}
                    </a>
                  </td>
                  <td class="px-6 py-4 text-zinc-300">
                    <div class="flex flex-col">
                      <span class="font-medium text-white">{{ o.vehiculo_marca }} {{ o.vehiculo_modelo }}</span>
                      <span class="text-xs text-zinc-500">{{ o.vehiculo_anio }} · {{ o.vehiculo_color }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4 font-mono text-zinc-400">{{ o.vehiculo_matricula|default:"-" }}</td>
                  <td class="px-6 py-4">
                    <span
                      class="inline-flex items-center rounded-md bg-zinc-800 px-2 py-1 text-xs font-medium text-zinc-300 ring-1 ring-inset ring-zinc-700/50">
                      {{ o.get_servicio_display }}
                    </span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      {% if o.estatus == 'LISTO' %}
                      <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                      {% elif o.estatus == 'RECIBIDO' %}
                      <span class="h-1.5 w-1.5 rounded-full bg-zinc-500"></span>
                      {% else %}
                      <span class="h-1.5 w-1.5 rounded-full bg-sky-500 animate-pulse"></span>
                      {% endif %}
                      <span class="text-zinc-300">{{ o.get_estatus_display }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-zinc-500">{{ o.actualizado_en|date:"d M H:i" }}</td>
                  <td class="px-6 py-4 text-right">
                    <a class="text-zinc-400 transition hover:text-white" href="{% url 'orden_editar' pk=o.pk %}">
                      Editar
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td class="px-6 py-12 text-center text-zinc-500" colspan="7">
                    No hay órdenes activas en este momento.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Entregadas -->
      {% if entregadas %}
      <div class="space-y-4 opacity-75 transition hover:opacity-100">
        <h2 class="flex items-center gap-2 text-lg font-semibold text-zinc-400">
          <span class="h-2 w-2 rounded-full bg-zinc-600"></span>
          Historial Entregadas
        </h2>

        <div class="md:hidden space-y-4">
          {% for o in entregadas %}
          <div class="rounded-2xl border border-zinc-800 bg-zinc-900/50 p-5 shadow-sm backdrop-blur-sm opacity-75">
            <div class="flex items-center justify-between mb-2 gap-2">
              <a href="{% url 'orden_detalle' pk=o.pk %}" class="font-medium text-zinc-300 hover:text-white truncate">
                {{ o.folio }}
              </a>
              <span class="shrink-0 text-xs text-zinc-500">{{ o.actualizado_en|date:"d M Y" }}</span>
            </div>
            <div class="mb-3">
              <p class="text-white break-words">{{ o.vehiculo_marca }} {{ o.vehiculo_modelo }}</p>
              <p class="text-xs text-zinc-500">{{ o.get_servicio_display }}</p>
            </div>
            <div class="flex justify-end border-t border-zinc-800/50 pt-2">
              <a class="text-xs font-medium text-zinc-500 hover:text-zinc-300" href="{% url 'orden_editar' pk=o.pk %}">
                Editar &rarr;
              </a>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="hidden md:block overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/30">
          <div class="overflow-x-auto">
            <table class="w-full whitespace-nowrap text-left text-sm">
              <thead class="bg-zinc-950/50 text-zinc-500">
                <tr>
                  <th class="px-6 py-4 font-medium">Folio</th>
                  <th class="px-6 py-4 font-medium">Vehículo</th>
                  <th class="px-6 py-4 font-medium">Matrícula</th>
                  <th class="px-6 py-4 font-medium">Servicio</th>
                  <th class="px-6 py-4 font-medium">Entregado</th>
                  <th class="px-6 py-4 text-right font-medium">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-zinc-800/50">
                {% for o in entregadas %}
                <tr class="transition hover:bg-zinc-800/30">
                  <td class="px-6 py-4">
                    <a class="font-medium text-zinc-300 hover:text-white hover:underline"
                      href="{% url 'orden_detalle' pk=o.pk %}">
                      {{ o.folio }}
                    </a>
                  </td>
                  <td class="px-6 py-4 text-zinc-400">
                    {{ o.vehiculo_marca }} {{ o.vehiculo_modelo }}
                  </td>
                  <td class="px-6 py-4 font-mono text-zinc-500">{{ o.vehiculo_matricula|default:"-" }}</td>
                  <td class="px-6 py-4 text-zinc-500">{{ o.get_servicio_display }}</td>
                  <td class="px-6 py-4 text-zinc-500">{{ o.actualizado_en|date:"d M Y" }}</td>
                  <td class="px-6 py-4 text-right">
                    <a class="text-zinc-500 transition hover:text-zinc-300" href="{% url 'orden_editar' pk=o.pk %}">
                      Editar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar: Citas -->
    <div class="flex min-w-0 flex-col gap-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white">Próximas Citas</h2>
        <a class="rounded-lg border border-zinc-700 bg-zinc-800 px-3 py-1.5 text-xs font-medium text-zinc-300 transition hover:bg-zinc-700 hover:text-white"
          href="{% url 'cita_nueva' %}">
          + Agendar
        </a>
      </div>

      <div class="space-y-4">
        {% for cita in citas_proximas %}
        <div
          class="group relative overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/50 p-5 transition hover:border-zinc-700 hover:bg-zinc-900">
          <div
            class="absolute right-0 top-0 h-16 w-16 -translate-y-8 translate-x-8 rounded-full bg-sky-500/10 blur-xl transition group-hover:bg-sky-500/20">
          </div>

          <div class="relative z-10">
            <div class="flex justify-between items-start gap-3">
              <div>
                <h3 class="font-semibold text-white group-hover:text-sky-300">{{ cita.cliente_nombre }}</h3>
                <p class="text-sm text-zinc-400">{{ cita.get_tipo_display }}</p>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-white">{{ cita.fecha|date:"d" }}</div>
                <div class="text-xs font-medium uppercase tracking-wider text-zinc-500">{{ cita.fecha|date:"M" }}</div>
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2 text-sm text-zinc-500">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {{ cita.fecha|date:"H:i" }} hrs
            </div>

            {% if cita.cliente_contacto %}
            <div class="mt-2 flex items-center gap-2 text-sm text-zinc-500">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
              </svg>
              {{ cita.cliente_contacto }}
            </div>
            {% endif %}

            <div class="mt-4 flex justify-end border-t border-zinc-800/50 pt-3">
              <a class="text-xs font-medium text-zinc-500 transition hover:text-white"
                href="{% url 'cita_editar' pk=cita.pk %}">Editar detalles &rarr;</a>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="rounded-2xl border border-dashed border-zinc-800 p-8 text-center">
          <p class="text-sm text-zinc-500">No hay citas programadas.</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}